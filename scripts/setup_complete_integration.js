/**
 * @file Script de configuraci√≥n completa para integraci√≥n Calendly-Twilio-OpenAI
 * @description Configura y verifica toda la integraci√≥n paso a paso
 */

require("dotenv").config({ path: ".env" });
require("dotenv").config({ path: ".env.local", override: true });

const logger = require("../src/utils/logger");

async function setupCompleteIntegration() {
  console.log("üöÄ CONFIGURACI√ìN COMPLETA DE INTEGRACI√ìN");
  console.log("=".repeat(60));

  const results = {
    environment: false,
    database: false,
    openai: false,
    twilio: false,
    calendly: false,
    webhooks: false,
    integration: false,
  };

  try {
    // 1. Verificar variables de entorno
    console.log("\n1Ô∏è‚É£ VERIFICANDO VARIABLES DE ENTORNO...");
    results.environment = await checkEnvironmentVariables();

    // 2. Verificar base de datos
    console.log("\n2Ô∏è‚É£ VERIFICANDO BASE DE DATOS...");
    results.database = await checkDatabase();

    // 3. Verificar OpenAI
    console.log("\n3Ô∏è‚É£ VERIFICANDO OPENAI...");
    results.openai = await checkOpenAI();

    // 4. Verificar Twilio
    console.log("\n4Ô∏è‚É£ VERIFICANDO TWILIO...");
    results.twilio = await checkTwilio();

    // 5. Verificar Calendly
    console.log("\n5Ô∏è‚É£ VERIFICANDO CALENDLY...");
    results.calendly = await checkCalendly();

    // 6. Configurar webhooks
    console.log("\n6Ô∏è‚É£ CONFIGURANDO WEBHOOKS...");
    results.webhooks = await setupWebhooks();

    // 7. Probar integraci√≥n completa
    console.log("\n7Ô∏è‚É£ PROBANDO INTEGRACI√ìN COMPLETA...");
    results.integration = await testCompleteIntegration();

    // 8. Resumen final
    console.log("\n" + "=".repeat(60));
    console.log("üìä RESUMEN DE CONFIGURACI√ìN");
    console.log("=".repeat(60));

    Object.entries(results).forEach(([component, status]) => {
      const icon = status ? "‚úÖ" : "‚ùå";
      const statusText = status ? "OK" : "FAIL";
      console.log(`  ${component.padEnd(15)}: ${icon} ${statusText}`);
    });

    const allOk = Object.values(results).every(Boolean);
    console.log(
      `\nüéØ ESTADO GENERAL: ${allOk ? "‚úÖ COMPLETADO" : "‚ùå REQUIERE ATENCI√ìN"}`
    );

    if (!allOk) {
      console.log("\nüîß ACCIONES REQUERIDAS:");
      if (!results.environment)
        console.log("  ‚Ä¢ Configurar variables de entorno faltantes");
      if (!results.database)
        console.log("  ‚Ä¢ Verificar conexi√≥n y esquema de base de datos");
      if (!results.openai) console.log("  ‚Ä¢ Verificar API key de OpenAI");
      if (!results.twilio) console.log("  ‚Ä¢ Verificar credenciales de Twilio");
      if (!results.calendly)
        console.log("  ‚Ä¢ Verificar configuraci√≥n de Calendly");
      if (!results.webhooks)
        console.log("  ‚Ä¢ Configurar webhooks correctamente");
      if (!results.integration)
        console.log("  ‚Ä¢ Resolver problemas de integraci√≥n");
    }

    return allOk;
  } catch (error) {
    console.error("\n‚ùå ERROR CR√çTICO EN CONFIGURACI√ìN:", error);
    return false;
  }
}

async function checkEnvironmentVariables() {
  const requiredVars = [
    "SUPABASE_URL",
    "SUPABASE_SERVICE_KEY",
    "OPENAI_API_KEY",
    "TWILIO_ACCOUNT_SID",
    "TWILIO_AUTH_TOKEN",
    "TWILIO_WHATSAPP_NUMBER",
    "CALENDLY_ACCESS_TOKEN",
    "CALENDLY_USER_URI",
    "JWT_SECRET",
    "JWT_REFRESH_SECRET",
  ];

  const missing = [];
  const weak = [];

  requiredVars.forEach((varName) => {
    const value = process.env[varName];
    if (!value) {
      missing.push(varName);
    } else if (varName.includes("SECRET") && value.length < 32) {
      weak.push(varName);
    }
  });

  if (missing.length > 0) {
    console.log(`  ‚ùå Variables faltantes: ${missing.join(", ")}`);
    return false;
  }

  if (weak.length > 0) {
    console.log(`  ‚ö†Ô∏è Variables d√©biles: ${weak.join(", ")}`);
  }

  console.log("  ‚úÖ Todas las variables de entorno est√°n configuradas");
  return true;
}

async function checkDatabase() {
  try {
    const { createClient } = require("@supabase/supabase-js");
    const { SUPABASE_URL, SUPABASE_SERVICE_KEY } = require("../src/config/env");

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    // Verificar conexi√≥n
    const { data: connectionTest, error: connectionError } = await supabase
      .from("services")
      .select("count")
      .limit(1);

    if (connectionError) {
      console.log(`  ‚ùå Error de conexi√≥n: ${connectionError.message}`);
      return false;
    }

    // Verificar tablas principales
    const tables = ["clients", "services", "appointments", "users"];
    const tableResults = {};

    for (const table of tables) {
      try {
        const { data, error } = await supabase
          .from(table)
          .select("count")
          .limit(1);

        tableResults[table] = !error;
        if (error) {
          console.log(`  ‚ö†Ô∏è Tabla ${table}: ${error.message}`);
        }
      } catch (err) {
        tableResults[table] = false;
        console.log(`  ‚ùå Tabla ${table}: Error de acceso`);
      }
    }

    const allTablesOk = Object.values(tableResults).every(Boolean);

    if (allTablesOk) {
      console.log("  ‚úÖ Base de datos y tablas principales verificadas");
    } else {
      console.log("  ‚ùå Algunas tablas tienen problemas");
    }

    return allTablesOk;
  } catch (error) {
    console.log(`  ‚ùå Error verificando base de datos: ${error.message}`);
    return false;
  }
}

async function checkOpenAI() {
  try {
    const openaiClient = require("../src/integrations/openaiClient");

    const testResponse = await openaiClient.generateResponse(
      "Test de configuraci√≥n",
      {
        max_tokens: 10,
      }
    );

    if (testResponse) {
      console.log("  ‚úÖ OpenAI configurado y funcionando");
      return true;
    } else {
      console.log("  ‚ùå OpenAI no responde correctamente");
      return false;
    }
  } catch (error) {
    console.log(`  ‚ùå Error con OpenAI: ${error.message}`);
    return false;
  }
}

async function checkTwilio() {
  try {
    const twilioClient = require("../src/integrations/twilioClient");

    const account = await twilioClient.api
      .accounts(twilioClient.accountSid)
      .fetch();

    if (account) {
      console.log(`  ‚úÖ Twilio configurado - Cuenta: ${account.friendlyName}`);

      // Verificar n√∫mero de WhatsApp
      const whatsappNumber = process.env.TWILIO_WHATSAPP_NUMBER;
      if (whatsappNumber) {
        console.log(`  ‚úÖ N√∫mero WhatsApp configurado: ${whatsappNumber}`);
      } else {
        console.log("  ‚ö†Ô∏è N√∫mero de WhatsApp no configurado");
      }

      return true;
    } else {
      console.log("  ‚ùå No se pudo verificar cuenta de Twilio");
      return false;
    }
  } catch (error) {
    console.log(`  ‚ùå Error con Twilio: ${error.message}`);
    return false;
  }
}

async function checkCalendly() {
  try {
    const calendlyClient = require("../src/integrations/calendlyClient");

    if (!calendlyClient.isInitialized()) {
      console.log("  ‚ùå Calendly no est√° inicializado");
      return false;
    }

    // Intentar obtener informaci√≥n del usuario
    const userUri = process.env.CALENDLY_USER_URI;
    if (userUri) {
      console.log(`  ‚úÖ Calendly configurado - Usuario: ${userUri}`);
      return true;
    } else {
      console.log("  ‚ùå URI de usuario de Calendly no configurado");
      return false;
    }
  } catch (error) {
    console.log(`  ‚ùå Error con Calendly: ${error.message}`);
    return false;
  }
}

async function setupWebhooks() {
  try {
    const webhookUrls = {
      calendly:
        process.env.NODE_ENV === "production"
          ? process.env.CALENDLY_WEBHOOK_URI
          : process.env.CALENDLY_WEBHOOK_URI_DEV,
      whatsapp: process.env.TWILIO_WEBHOOK_URL,
    };

    console.log("  üìã URLs de webhook configuradas:");
    console.log(`    ‚Ä¢ Calendly: ${webhookUrls.calendly}`);
    console.log(`    ‚Ä¢ WhatsApp: ${webhookUrls.whatsapp}`);

    // Verificar que los endpoints respondan
    let webhooksOk = true;

    for (const [service, url] of Object.entries(webhookUrls)) {
      if (url) {
        try {
          const response = await fetch(url.replace("/webhook", "/health"), {
            method: "GET",
            timeout: 5000,
          });

          if (response.ok) {
            console.log(`    ‚úÖ ${service}: Endpoint responde`);
          } else {
            console.log(
              `    ‚ö†Ô∏è ${service}: Endpoint responde con status ${response.status}`
            );
          }
        } catch (error) {
          console.log(`    ‚ùå ${service}: No se puede conectar`);
          webhooksOk = false;
        }
      } else {
        console.log(`    ‚ùå ${service}: URL no configurada`);
        webhooksOk = false;
      }
    }

    return webhooksOk;
  } catch (error) {
    console.log(`  ‚ùå Error configurando webhooks: ${error.message}`);
    return false;
  }
}

async function testCompleteIntegration() {
  try {
    const integrationOrchestrator = require("../src/services/integrationOrchestrator");

    // Realizar health check
    const healthCheck = await integrationOrchestrator.performHealthChecks();

    console.log("  üìä Estado de servicios:");
    Object.entries(healthCheck.results).forEach(([service, status]) => {
      console.log(`    ${service}: ${status ? "‚úÖ" : "‚ùå"}`);
    });

    if (healthCheck.allHealthy) {
      console.log("  ‚úÖ Integraci√≥n completa funcionando");
      return true;
    } else {
      console.log("  ‚ùå Algunos servicios tienen problemas");
      return false;
    }
  } catch (error) {
    console.log(`  ‚ùå Error probando integraci√≥n: ${error.message}`);
    return false;
  }
}

// Funci√≥n para generar configuraci√≥n de ejemplo
async function generateExampleConfig() {
  console.log("üìù GENERANDO CONFIGURACI√ìN DE EJEMPLO");
  console.log("=".repeat(50));

  const exampleConfig = `
# =================================
# CONFIGURACI√ìN DE EJEMPLO - .env.local
# =================================

# Servidor
PORT=3000
NODE_ENV=development

# Base de datos (Supabase)
SUPABASE_URL=https://tu-proyecto.supabase.co
SUPABASE_ANON_KEY=tu_anon_key
SUPABASE_SERVICE_KEY=tu_service_key

# OpenAI
OPENAI_API_KEY=sk-proj-tu_api_key
OPENAI_MODEL=gpt-4-turbo
OPENAI_MAX_TOKENS=1000

# Twilio
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=tu_auth_token
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886

# Calendly
CALENDLY_ACCESS_TOKEN=tu_access_token
CALENDLY_USER_URI=https://api.calendly.com/users/tu_user_id
CALENDLY_CLIENT_ID=tu_client_id
CALENDLY_CLIENT_SECRET=tu_client_secret
CALENDLY_WEBHOOK_URI=https://tu-dominio.com/api/calendly/webhook

# Seguridad
JWT_SECRET=tu_jwt_secret_muy_largo_y_seguro
JWT_REFRESH_SECRET=tu_refresh_secret_muy_largo_y_seguro

# Webhooks
TWILIO_WEBHOOK_URL=https://tu-dominio.com/webhook/whatsapp
CALENDLY_WEBHOOK_SIGNING_KEY=tu_signing_key
`;

  console.log(exampleConfig);

  console.log("\nüîß PASOS PARA CONFIGURAR:");
  console.log("1. Copia esta configuraci√≥n a tu archivo .env.local");
  console.log(
    "2. Reemplaza todos los valores 'tu_*' con tus credenciales reales"
  );
  console.log("3. Ejecuta: node scripts/setup_complete_integration.js");
  console.log("4. Sigue las instrucciones para corregir cualquier problema");
}

// Ejecutar seg√∫n argumentos
if (require.main === module) {
  const args = process.argv.slice(2);

  if (args.includes("--example-config")) {
    generateExampleConfig();
  } else {
    setupCompleteIntegration()
      .then((success) => {
        process.exit(success ? 0 : 1);
      })
      .catch((error) => {
        console.error("Error:", error);
        process.exit(1);
      });
  }
}

module.exports = {
  setupCompleteIntegration,
  checkEnvironmentVariables,
  checkDatabase,
  checkOpenAI,
  checkTwilio,
  checkCalendly,
  generateExampleConfig,
};
